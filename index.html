<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×“×©×‘×•×¨×“ ××•×›×œ×•×¡×™×™×” ×œ×¤×™ ×’×™×œ ×•×™×™×©×•×‘ â€“ data.gov.il</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      direction: rtl;
    }
    .page {
      max-width: 1250px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }
    header {
      margin-bottom: 16px;
    }
    header h1 {
      margin: 0;
      font-size: 1.9rem;
    }
    header p {
      margin: 4px 0 0;
      color: #6b7280;
      font-size: 0.95rem;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      margin-top: 6px;
    }
    .tag code {
      background: transparent;
      padding: 0;
      font-size: 0.8rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
    }

    /* side panel */
    .side-card h2 {
      margin: 0 0 10px;
      font-size: 1.05rem;
    }
    .side-card section {
      margin-bottom: 14px;
    }
    .side-card label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #374151;
    }
    .side-card input[type="number"],
    .side-card input[type="text"],
    .side-card select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    .side-card input:focus,
    .side-card select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }
    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .error {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #b91c1c;
    }
    .loading {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    /* main */
    .main {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .kpi {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .kpi-label {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .kpi-value {
      font-size: 1.25rem;
      font-weight: 700;
    }
    .kpi-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .charts {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }
    .chart-card h3 {
      margin: 0 0 6px;
      font-size: 0.95rem;
    }
    .chart-card canvas {
      max-height: 260px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .table-header h3 {
      margin: 0;
      font-size: 0.95rem;
    }
    .table-header span {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 420px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
      font-size: 0.8rem;
    }
    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #374151;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .no-data {
      text-align: center;
      padding: 16px;
      color: #6b7280;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: #4b5563;
    }
    .pagination-buttons {
      display: flex;
      gap: 6px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }
    button.primary {
      background: #2563eb;
      color: #ffffff;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    code {
      background: #e5e7eb;
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>×“×©×‘×•×¨×“ ××•×›×œ×•×¡×™×™×” ×œ×¤×™ ×’×™×œ ×•×™×™×©×•×‘</h1>
      <p>
        × ×ª×•× ×™× ××ª×•×š ×××’×¨ ××•×›×œ×•×¡×™×™×” ×œ×¤×™ ×’×™×œ ×•×™×™×©×•×‘ ×‘Ö¾<strong>data.gov.il</strong>,
        × ×˜×¢× ×™× ××•×˜×•××˜×™×ª ×“×¨×š
        <code>datastore_search</code>.
      </p>
      <div class="tag">
        resource_id:
        <code>64edd0ee-3d5d-43ce-8562-c336c24dbc1f</code>
      </div>
    </header>

    <div class="layout">
      <!-- side panel -->
      <aside class="card side-card">
        <h2>×¤×™×œ×˜×¨×™×</h2>

        <section>
          <label for="searchText">×—×™×¤×•×© (×©× ×™×™×©×•×‘ / ×¡××œ)</label>
          <input id="searchText" type="text" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘ ××• 5000" />
          <div class="small">
            ×”×—×™×¤×•×© ×¢×•×‘×“ ×’× ×¢×œ ×—×œ×§×™× ××”×©× ×•×’× ×¢×œ ×¡××œ ×”×™×™×©×•×‘.
          </div>
        </section>

        <section>
          <label for="minPop">××™× ×™××•× ××•×›×œ×•×¡×™×™×” (×¡×”×´×›)</label>
          <input id="minPop" type="number" placeholder="×œ××©×œ 10000" />
          <div class="small">
            ×”×©××¨ ×¨×™×§ ×›×“×™ ×œ×›×œ×•×œ ×’× ×™×™×©×•×‘×™× ×§×˜× ×™×.
          </div>
        </section>

        <section>
          <label for="districtFilter">× ×¤×”</label>
          <select id="districtFilter">
            <option value="">×›×œ ×”× ×¤×•×ª</option>
          </select>
        </section>

        <section>
          <label for="councilFilter">××•×¢×¦×” ××–×•×¨×™×ª</label>
          <select id="councilFilter">
            <option value="">×›×œ ×”××•×¢×¦×•×ª / ×¢×¨×™×</option>
          </select>
        </section>

        <section>
          <button id="applyFilters" class="primary" type="button">×”×—×œ ×¡×™× ×•×Ÿ</button>
        </section>

        <section>
          <div id="loadState" class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”-API...</div>
          <div id="errorState" class="error" style="display:none;"></div>
          <div class="pill">
            ğŸ”
            <span class="small">
              ×”× ×ª×•× ×™× ××ª×¢×“×›× ×™× ×œ×¤×™ ×”××™×“×¢ ×”×¢×“×›× ×™ ×‘×××’×¨, ×”×“×©×‘×•×¨×“ ××•×©×š ×‘×›×œ ×¨×¢× ×•×Ÿ ×“×£.
            </span>
          </div>
        </section>
      </aside>

      <!-- main -->
      <main class="main">
        <!-- KPIs -->
        <section class="card">
          <div class="kpis">
            <div class="kpi">
              <div class="kpi-label">×¡×”×´×› ××•×›×œ×•×¡×™×™×” (×›×œ ×”×™×™×©×•×‘×™×)</div>
              <div class="kpi-value" id="kpiTotalPop">â€“</div>
              <div class="kpi-sub">×¡×›×•× ×¢××•×“×ª <code>×¡×”×›</code></div>
            </div>
            <div class="kpi">
              <div class="kpi-label">××¡×³ ×™×™×©×•×‘×™×</div>
              <div class="kpi-value" id="kpiCitiesCount">â€“</div>
              <div class="kpi-sub">×›×¤×™ ×©××•×¤×™×¢ ×‘×××’×¨</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">% ×™×œ×“×™× (0â€“18) ××ª×•×š ×›×œ×œ ×”××•×›×œ×•×¡×™×™×”</div>
              <div class="kpi-value" id="kpiChildrenShare">â€“</div>
              <div class="kpi-sub">×’×™×œ_0_5 + ×’×™×œ_6_18</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">% ××‘×•×’×¨×™× (65+) ××ª×•×š ×›×œ×œ ×”××•×›×œ×•×¡×™×™×”</div>
              <div class="kpi-value" id="kpiSeniorsShare">â€“</div>
              <div class="kpi-sub">×’×™×œ_65_×¤×œ×•×¡</div>
            </div>
          </div>
        </section>

        <!-- charts -->
        <section class="charts">
          <div class="card chart-card">
            <h3>×”×ª×¤×œ×’×•×ª ×’×™×œ××™×ª â€“ ×›×œ×œ ×”×™×™×©×•×‘×™×</h3>
            <canvas id="ageDistChart"></canvas>
            <div class="small">
              ×¡×›×™××” ×©×œ ×›×œ ×”×™×™×©×•×‘×™× ×œ×¤×™ ×§×‘×•×¦×•×ª ×”×’×™×œ:
              0â€“5, 6â€“18, 19â€“45, 46â€“55, 56â€“64, 65+.
            </div>
          </div>
          <div class="card chart-card">
            <h3>TOP 10 â€“ ××—×•×– ×™×œ×“×™× (0â€“18)</h3>
            <canvas id="topChildrenChart"></canvas>
            <div class="small">
              ×™×™×©×•×‘×™× ×¢× ×”××—×•×– ×”×’×‘×•×” ×‘×™×•×ª×¨ ×©×œ ×™×œ×“×™× (0â€“18) ××ª×•×š ×¡×”×´×› ×”××•×›×œ×•×¡×™×™×”, ××—×¨×™ ×”×¤×™×œ×˜×¨×™×.
            </div>
          </div>
        </section>

        <section class="charts">
          <div class="card chart-card">
            <h3>TOP 10 â€“ ××—×•×– ×‘× ×™ 65+</h3>
            <canvas id="topSeniorsChart"></canvas>
            <div class="small">
              ×™×™×©×•×‘×™× ×¢× ×”××—×•×– ×”×’×‘×•×” ×‘×™×•×ª×¨ ×©×œ ×‘× ×™ 65+ ××ª×•×š ×¡×”×´×› ×”××•×›×œ×•×¡×™×™×”, ××—×¨×™ ×”×¤×™×œ×˜×¨×™×.
            </div>
          </div>
          <div class="card chart-card">
            <h3>×™×™×©×•×‘×™× × ×‘×—×¨×™× â€“ ×™×œ×“×™× ××•×œ 65+</h3>
            <canvas id="childrenVsSeniorsChart"></canvas>
            <div class="small">
              ×”×©×•×•××ª ××—×•×– ×™×œ×“×™× ×•××—×•×– ×‘× ×™ 65+ ×‘Ö¾5 ×”×™×™×©×•×‘×™× ×”×’×“×•×œ×™× ×‘×™×•×ª×¨ (×œ×¤×™ ××•×›×œ×•×¡×™×™×”) ××—×¨×™ ×”×¤×™×œ×˜×¨×™×.
            </div>
          </div>
        </section>

        <!-- table -->
        <section class="card">
          <div class="table-header">
            <h3>×˜×‘×œ×ª ×™×™×©×•×‘×™× (×œ××—×¨ ×¡×™× ×•×Ÿ)</h3>
            <span id="tableInfo">â€“</span>
          </div>
          <div class="table-wrapper">
            <div class="no-data" id="noDataMsg">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            <table id="dataTable" style="display:none;">
              <thead>
                <tr>
                  <th>×¡××œ ×™×™×©×•×‘</th>
                  <th>×©× ×™×™×©×•×‘</th>
                  <th>× ×¤×”</th>
                  <th>××•×¢×¦×” ××–×•×¨×™×ª</th>
                  <th>×¡×”×´×›</th>
                  <th>0â€“5</th>
                  <th>6â€“18</th>
                  <th>19â€“45</th>
                  <th>46â€“55</th>
                  <th>56â€“64</th>
                  <th>65+</th>
                  <th>% ×™×œ×“×™×</th>
                  <th>% 65+</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="pagination" style="display:none;">
            <div id="paginationInfo"></div>
            <div class="pagination-buttons">
              <button id="prevPage">â† ×§×•×“×</button>
              <button id="nextPage">×”×‘× â†’</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ----- dataset info -----
    const RESOURCE_ID = "64edd0ee-3d5d-43ce-8562-c336c24dbc1f";
    const DATASTORE_URL = "https://data.gov.il/api/3/action/datastore_search";

    // field names (Hebrew) â€“ ×‘×“×™×•×§ ×›××• ×‘×××’×¨
    const FIELD_CODE = "×¡××œ_×™×©×•×‘";
    const FIELD_NAME = "×©×_×™×©×•×‘";
    const FIELD_NAFA = "× ×¤×”";
    const FIELD_COUNCIL = "××•×¢×¦×”_××–×•×¨×™×ª";
    const FIELD_TOTAL = "×¡×”×›";
    const FIELD_0_5 = "×’×™×œ_0_5";
    const FIELD_6_18 = "×’×™×œ_6_18";
    const FIELD_19_45 = "×’×™×œ_19_45";
    const FIELD_46_55 = "×’×™×œ_46_55";
    const FIELD_56_64 = "×’×™×œ_56_64";
    const FIELD_65_PLUS = "×’×™×œ_65_×¤×œ×•×¡";

    // ----- state -----
    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    const PAGE_SIZE = 30;

    // DOM
    const loadStateEl = document.getElementById("loadState");
    const errorStateEl = document.getElementById("errorState");

    const searchTextEl = document.getElementById("searchText");
    const minPopEl = document.getElementById("minPop");
    const districtFilterEl = document.getElementById("districtFilter");
    const councilFilterEl = document.getElementById("councilFilter");
    const applyFiltersBtn = document.getElementById("applyFilters");

    const kpiTotalPop = document.getElementById("kpiTotalPop");
    const kpiCitiesCount = document.getElementById("kpiCitiesCount");
    const kpiChildrenShare = document.getElementById("kpiChildrenShare");
    const kpiSeniorsShare = document.getElementById("kpiSeniorsShare");

    const ageDistChartCanvas = document.getElementById("ageDistChart");
    const topChildrenChartCanvas = document.getElementById("topChildrenChart");
    const topSeniorsChartCanvas = document.getElementById("topSeniorsChart");
    const childrenVsSeniorsChartCanvas = document.getElementById("childrenVsSeniorsChart");

    const noDataMsg = document.getElementById("noDataMsg");
    const dataTable = document.getElementById("dataTable");
    const tableBody = document.getElementById("tableBody");
    const tableInfo = document.getElementById("tableInfo");

    const paginationEl = document.getElementById("pagination");
    const paginationInfo = document.getElementById("paginationInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    let ageDistChart = null;
    let topChildrenChart = null;
    let topSeniorsChart = null;
    let childrenVsSeniorsChart = null;

    function setLoading(msg) {
      loadStateEl.style.display = "block";
      loadStateEl.textContent = msg;
      errorStateEl.style.display = "none";
    }

    function setError(msg) {
      errorStateEl.style.display = "block";
      errorStateEl.textContent = msg;
      loadStateEl.style.display = "none";
    }

    function clearStatus() {
      loadStateEl.style.display = "none";
      errorStateEl.style.display = "none";
    }

    function num(x) {
      const n = typeof x === "number" ? x : parseFloat(String(x).replace(/,/g, ""));
      return isNaN(n) ? 0 : n;
    }

    function formatInt(n) {
      return n.toLocaleString("he-IL", { maximumFractionDigits: 0 });
    }

    function formatPct(numVal, denom) {
      if (!denom || denom === 0) return "â€“";
      const v = (numVal / denom) * 100;
      return v.toFixed(1) + "%";
    }

    // ----- load dataset -----
    async function loadAllData() {
      try {
        setLoading("×˜×•×¢×Ÿ ××ª ×›×œ ×”×¨×©×•××•×ª ××”-DataStore...");
        let limit = 1000;
        let offset = 0;
        let done = false;
        const rows = [];

        while (!done) {
          const params = new URLSearchParams();
          params.append("resource_id", RESOURCE_ID);
          params.append("limit", String(limit));
          params.append("offset", String(offset));
          const url = DATASTORE_URL + "?" + params.toString();

          const res = await fetch(url);
          if (!res.ok) throw new Error("×©×’×™××ª HTTP: " + res.status);

          const json = await res.json();
          if (!json.success) throw new Error("success=false ××”-API");

          const result = json.result || {};
          const batch = result.records || [];
          rows.push(...batch);

          const total = result.total ?? rows.length;
          offset += batch.length;
          if (!batch.length || offset >= total) done = true;
        }

        allRows = rows;
        filteredRows = [...allRows];

        clearStatus();
        initFiltersOptions();
        computeKpis();
        renderAll();
      } catch (err) {
        console.error(err);
        setError("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: " + err.message);
      }
    }

    function initFiltersOptions() {
      // × ×¤×•×ª
      const nafas = Array.from(
        new Set(
          allRows
            .map(r => r[FIELD_NAFA])
            .filter(v => v !== null && v !== undefined && v !== "")
        )
      ).sort((a, b) => String(a).localeCompare(String(b), "he"));
      districtFilterEl.innerHTML = '<option value="">×›×œ ×”× ×¤×•×ª</option>';
      nafas.forEach(n => {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = String(n);
        districtFilterEl.appendChild(opt);
      });

      // ××•×¢×¦×•×ª ××–×•×¨×™×•×ª
      const councils = Array.from(
        new Set(
          allRows
            .map(r => r[FIELD_COUNCIL])
            .filter(v => v !== null && v !== undefined && v !== "")
        )
      ).sort((a, b) => String(a).localeCompare(String(b), "he"));
      councilFilterEl.innerHTML = '<option value="">×›×œ ×”××•×¢×¦×•×ª / ×¢×¨×™×</option>';
      councils.forEach(c => {
        const opt = document.createElement("option");
        opt.value = String(c);
        opt.textContent = String(c);
        councilFilterEl.appendChild(opt);
      });
    }

    // ----- KPIs -----
    function computeKpis() {
      const totalPop = allRows.reduce((sum, r) => sum + num(r[FIELD_TOTAL]), 0);
      const totalChildren = allRows.reduce(
        (sum, r) => sum + num(r[FIELD_0_5]) + num(r[FIELD_6_18]),
        0
      );
      const totalSeniors = allRows.reduce(
        (sum, r) => sum + num(r[FIELD_65_PLUS]),
        0
      );

      kpiTotalPop.textContent = formatInt(totalPop);
      kpiCitiesCount.textContent = allRows.length.toLocaleString("he-IL");
      kpiChildrenShare.textContent = formatPct(totalChildren, totalPop);
      kpiSeniorsShare.textContent = formatPct(totalSeniors, totalPop);
    }

    // ----- filters -----
    function applyFilters(shouldScroll = true) {
      const text = (searchTextEl.value || "").trim().toLowerCase();
      const minPop = minPopEl.value ? parseInt(minPopEl.value, 10) : null;
      const nafa = districtFilterEl.value;
      const council = councilFilterEl.value;

      filteredRows = allRows.filter(row => {
        let ok = true;

        const total = num(row[FIELD_TOTAL]);
        if (minPop !== null && total < minPop) ok = false;

        if (nafa) {
          if (String(row[FIELD_NAFA] ?? "") !== nafa) ok = false;
        }

        if (council) {
          if (String(row[FIELD_COUNCIL] ?? "") !== council) ok = false;
        }

        if (text) {
          const codeStr = String(row[FIELD_CODE] ?? "").toLowerCase();
          const nameStr = String(row[FIELD_NAME] ?? "").toLowerCase();
          if (!codeStr.includes(text) && !nameStr.includes(text)) {
            ok = false;
          }
        }

        return ok;
      });

      currentPage = 1;
      renderAll();

      if (shouldScroll) {
        document.querySelector(".table-header")?.scrollIntoView({ behavior: "smooth" });
      }
    }

    // ----- table -----
    function renderTable() {
      if (!filteredRows.length) {
        dataTable.style.display = "none";
        noDataMsg.style.display = "block";
        noDataMsg.textContent =
          allRows.length === 0
            ? "×œ× × ××¦××• × ×ª×•× ×™× ×‘×××’×¨."
            : "××™×Ÿ ×™×™×©×•×‘×™× ×”×ª×•×××™× ×œ×¤×™×œ×˜×¨×™×.";
        paginationEl.style.display = "none";
        tableInfo.textContent = "0 ×¨×©×•××•×ª ××¡×•× × ×•×ª.";
        return;
      }

      noDataMsg.style.display = "none";
      dataTable.style.display = "table";

      const total = filteredRows.length;
      const totalPages = Math.ceil(total / PAGE_SIZE);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);
      const pageRows = filteredRows.slice(start, end);

      tableBody.innerHTML = "";
      pageRows.forEach(row => {
        const tr = document.createElement("tr");

        const total = num(row[FIELD_TOTAL]);
        const children = num(row[FIELD_0_5]) + num(row[FIELD_6_18]);
        const seniors = num(row[FIELD_65_PLUS]);

        const cells = [
          row[FIELD_CODE],
          row[FIELD_NAME],
          row[FIELD_NAFA],
          row[FIELD_COUNCIL],
          formatInt(total),
          formatInt(num(row[FIELD_0_5])),
          formatInt(num(row[FIELD_6_18])),
          formatInt(num(row[FIELD_19_45])),
          formatInt(num(row[FIELD_46_55])),
          formatInt(num(row[FIELD_56_64])),
          formatInt(num(row[FIELD_65_PLUS])),
          formatPct(children, total),
          formatPct(seniors, total)
        ];

        cells.forEach(val => {
          const td = document.createElement("td");
          td.textContent = val == null ? "" : String(val);
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });

      tableInfo.textContent = `×¡×”×´×› ${total.toLocaleString(
        "he-IL"
      )} ×™×™×©×•×‘×™× ××—×¨×™ ×¡×™× ×•×Ÿ. ××¦×™×’ ${start + 1}â€“${end}.`;

      if (total > PAGE_SIZE) {
        paginationEl.style.display = "flex";
        paginationInfo.textContent = `×¢××•×“ ${currentPage} ××ª×•×š ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
      } else {
        paginationEl.style.display = "none";
      }
    }

    // ----- charts -----
    function renderCharts() {
      // ×”×’×™×œ××™× ×”××¡×•×›××™× â€“ ×›×œ ×”×™×™×©×•×‘×™×
      const src = filteredRows.length ? filteredRows : allRows;
      const sum = (field) => src.reduce((s, r) => s + num(r[field]), 0);

      const total0_5 = sum(FIELD_0_5);
      const total6_18 = sum(FIELD_6_18);
      const total19_45 = sum(FIELD_19_45);
      const total46_55 = sum(FIELD_46_55);
      const total56_64 = sum(FIELD_56_64);
      const total65plus = sum(FIELD_65_PLUS);

      const ageLabels = ["0â€“5", "6â€“18", "19â€“45", "46â€“55", "56â€“64", "65+"];
      const ageData = [
        total0_5,
        total6_18,
        total19_45,
        total46_55,
        total56_64,
        total65plus
      ];

      if (ageDistChart) ageDistChart.destroy();
      ageDistChart = new Chart(ageDistChartCanvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: ageLabels,
          datasets: [
            {
              label: "××¡×¤×¨ ×× ×©×™×",
              data: ageData
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => formatInt(ctx.parsed.y)
              }
            }
          },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });

      // TOP 10 ×™×œ×“×™×
      const rankedChildren = [...src]
        .filter(r => num(r[FIELD_TOTAL]) > 0)
        .map(r => {
          const total = num(r[FIELD_TOTAL]);
          const children = num(r[FIELD_0_5]) + num(r[FIELD_6_18]);
          return {
            name: String(r[FIELD_NAME]),
            pct: (children / total) * 100
          };
        })
        .sort((a, b) => b.pct - a.pct)
        .slice(0, 10);

      if (topChildrenChart) topChildrenChart.destroy();
      if (rankedChildren.length) {
        topChildrenChart = new Chart(topChildrenChartCanvas.getContext("2d"), {
          type: "bar",
          data: {
            labels: rankedChildren.map(r => r.name),
            datasets: [
              {
                label: "% ×™×œ×“×™×",
                data: rankedChildren.map(r => r.pct)
              }
            ]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => ctx.parsed.x.toFixed(1) + "%"
                }
              }
            },
            scales: {
              x: { beginAtZero: true }
            }
          }
        });
      }

      // TOP 10 ×‘× ×™ 65+
      const rankedSeniors = [...src]
        .filter(r => num(r[FIELD_TOTAL]) > 0)
        .map(r => {
          const total = num(r[FIELD_TOTAL]);
          const seniors = num(r[FIELD_65_PLUS]);
          return {
            name: String(r[FIELD_NAME]),
            pct: (seniors / total) * 100
          };
        })
        .sort((a, b) => b.pct - a.pct)
        .slice(0, 10);

      if (topSeniorsChart) topSeniorsChart.destroy();
      if (rankedSeniors.length) {
        topSeniorsChart = new Chart(topSeniorsChartCanvas.getContext("2d"), {
          type: "bar",
          data: {
            labels: rankedSeniors.map(r => r.name),
            datasets: [
              {
                label: "% 65+",
                data: rankedSeniors.map(r => r.pct)
              }
            ]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => ctx.parsed.x.toFixed(1) + "%"
                }
              }
            },
            scales: {
              x: { beginAtZero: true }
            }
          }
        });
      }

      // 5 ×”×™×™×©×•×‘×™× ×”×’×“×•×œ×™× â€“ ×”×©×•×•××ª ×™×œ×“×™× ××•×œ 65+
      const largest = [...src]
        .sort((a, b) => num(b[FIELD_TOTAL]) - num(a[FIELD_TOTAL]))
        .slice(0, 5);

      if (childrenVsSeniorsChart) childrenVsSeniorsChart.destroy();
      if (largest.length) {
        const labels = largest.map(r => String(r[FIELD_NAME]));
        const childrenValues = largest.map(r => {
          const total = num(r[FIELD_TOTAL]);
          const children = num(r[FIELD_0_5]) + num(r[FIELD_6_18]);
          return total ? (children / total) * 100 : 0;
        });
        const seniorsValues = largest.map(r => {
          const total = num(r[FIELD_TOTAL]);
          const seniors = num(r[FIELD_65_PLUS]);
          return total ? (seniors / total) * 100 : 0;
        });

        childrenVsSeniorsChart = new Chart(
          childrenVsSeniorsChartCanvas.getContext("2d"),
          {
            type: "bar",
            data: {
              labels,
              datasets: [
                { label: "% ×™×œ×“×™×", data: childrenValues },
                { label: "% 65+", data: seniorsValues }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: ctx => ctx.parsed.y.toFixed(1) + "%"
                  }
                }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          }
        );
      }
    }

    function renderAll() {
      renderTable();
      renderCharts();
    }

    // ----- events -----
    applyFiltersBtn.addEventListener("click", () => {
      applyFilters(true);
    });

    searchTextEl.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        applyFilters(true);
      }
    });

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    });

    // init
    window.addEventListener("load", () => {
      loadAllData();
    });
  </script>
</body>
</html>
